<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ระบบขอเบิกอะไหล่คลังสินค้านวนคร</title>

    <link href="https://fonts.googleapis.com/css2?family=Itim&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #eceff1;
        font-family: "Kanit", sans-serif;
      }

      .header {
        display: flex;
        justify-content: center;
        align-items: center;
        color: #1a3c87;
        padding: 10px 0;
        border-bottom: 2px solid #ff80ab;
        border-radius: 12px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        font-family: "Itim", cursive;
        overflow: hidden;
        position: relative;
        background: linear-gradient(135deg, #fff3e0, #ffebee);
        margin: 10px auto;
        max-width: 1500px;
        height: 52px;
        transition: transform 0.3s ease;
      }

      .header:hover {
        transform: translateY(-2px);
      }

      @keyframes slideRight {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }

      h1 {
        color: #1a3c87;
        margin: 0;
        font-size: 30px;
        font-weight: normal;
        text-shadow: 0.5px 0.5px 1px rgba(0, 0, 0, 0.1);
        animation: slideRight 20s linear infinite;
        white-space: nowrap;
        position: absolute;
  left: 0; /* ✅ เริ่มจากซ้ายสุด */
  width: 100%; /* ✅ ให้ข้อความใช้ความกว้างเต็ม */
  text-align: center; /* ✅ จัดกึ่งกลาง */
  animation: slideRight 7s linear infinite;
  white-space: nowrap;
      }

      .container {
        max-width: 1500px;
        margin: 0 auto;
        padding: 15px;
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        font-family: "Kanit", sans-serif;
      }

      .tabs {
        display: flex;
        margin-top: 5px;
        gap: 10px;
      }

      .tab-button {
        flex: 1;
        padding: 10px;
        text-align: center;
        background: linear-gradient(135deg, #42a5f5, #2196f3);
        color: white;
        cursor: pointer;
        border: none;
        outline: none;
        font-size: 18px;
        border-radius: 10px;
        transition: all 0.3s ease;
        font-family: "Kanit", sans-serif;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      .tab-button:hover {
        background: linear-gradient(135deg, #1976d2, #1565c0);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      }

      .tab-button.active {
        background: linear-gradient(135deg, #f06292, #ec407a);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transform: translateY(-2px);
      }

      .tab-content {
        display: none;
        padding: 15px;
        background-color: #fafafa;
        border-radius: 10px;
        margin-top: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }

      .tab-content.active {
        display: block;
      }

      .loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 22px;
        color: #2196f3;
        z-index: 9999;
        display: none;
      }

      iframe {
        width: 100%;
        height: 800px;
        border: none;
        border-radius: 10px;
      }

      .footer {
        background: linear-gradient(135deg, #0d47a1, #1565c0);
        color: white;
        text-align: center;
        padding: 10px 0;
        margin-top: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      .footer p {
        margin: 0;
        font-size: 14px;
      }

      .social-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
        padding: 10px;
      }

      .social-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        color: white;
        font-size: 18px;
        text-decoration: none;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }

      .social-button:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      }

      .social-button.facebook {
        background: linear-gradient(135deg, #3b5998, #2a4373);
      }

      .social-button.tiktok {
        background: linear-gradient(135deg, #000000, #333333);
      }

      .social-button.telegram {
        background: linear-gradient(135deg, #26A5E4, #1b87b9);
      }

      .social-button.qrcode {
        background: linear-gradient(135deg, #4caf50, #388e3c);
      }

      @media screen and (max-width: 360px) {
        .social-button {
          width: 36px;
          height: 36px;
          font-size: 16px;
        }

        .social-buttons {
          gap: 8px;
        }
      }

      #parts, #today {
        font-family: "Poppins", sans-serif;
        background-color: #f0f4f8;
        padding: 15px;
        border-radius: 8px;
      }

      #parts #searchContainer, #today #searchContainer {
        display: flex;
        justify-content: flex-start;
        margin-bottom: 15px;
      }

      #parts #searchInput, #today #searchInputToday {
        width: 100%;
        max-width: 300px;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        font-size: 15px;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }

      #parts #searchInput:focus, #today #searchInputToday:focus {
        border-color: #2196f3;
        box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        outline: none;
      }

      #parts .refresh-button {
        background: linear-gradient(135deg, #42a5f5, #2196f3);
        color: #fff;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        margin-left: 10px;
      }

      #parts .refresh-button:hover {
        background: linear-gradient(135deg, #1976d2, #1565c0);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      #parts table, #today table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        border-radius: 8px;
        overflow: hidden;
      }

      #parts th, #parts td, #today th, #today td {
        padding: 10px;
        text-align: center;
        border: 1px solid #e0e0e0;
        font-size: 15px;
      }

      #parts th, #today th {
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
        position: sticky;
        top: 0;
        z-index: 1;
      }

      #parts tr:hover, #today tr:hover {
        background-color: #f55f5;
      }

      #parts .table-container, #today .table-container {
        max-height: 80vh;
        overflow-y: auto;
        overflow-x: auto;
        background: white;
        border-radius: 8px;
      }

      #parts .pagination {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        margin-top: 12px;
      }

      #parts .pagination button {
        background: linear-gradient(135deg, #42a5f5, #2196f3);
        color: white;
        padding: 8px;
        border: none;
        border-radius: 50%;
        margin: 0 5px;
        cursor: pointer;
        width: 36px;
        height: 36px;
        font-size: 13px;
        transition: all 0.3s ease;
      }

      #parts .pagination button:hover {
        background: linear-gradient(135deg, #1976d2, #1565c0);
        transform: translateY(-2px);
      }

      #parts .pagination .active {
        background: linear-gradient(135deg, #ff9800, #f57c00);
      }

      #parts .pagination button:disabled {
        background: #b0bec5;
        cursor: not-allowed;
      }

      #parts .pagination select {
        padding: 8px;
        border-radius: 6px;
        margin: 0 10px;
        font-size: 14px;
      }

      #parts .table-container, #today .table-container {
        overflow-x: auto;
        width: 100%;
      }

      #parts table, #today table {
        min-width: 900px;
      }

      #parts td, #today td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #parts td:nth-child(3), #today td:nth-child(4) {
        text-align: left;
      }

      #parts th:nth-child(3), #parts td:nth-child(3), #today th:nth-child(4), #today td:nth-child(4) {
        min-width: 300px;
      }

      #parts th:nth-child(4), #parts td:nth-child(4), #today th:nth-child(6), #today td:nth-child(6) {
        min-width: 50px;
      }

      #parts th:nth-child(5), #parts td:nth-child(5) {
        min-width: 50px;
      }

      #parts th:nth-child(6), #parts td:nth-child(6), #today th:nth-child(11), #today td:nth-child(11) {
        min-width: 250px;
      }

      #parts th:nth-child(7), #parts td:nth-child(7) {
        min-width: 150px;
      }

      #parts .requisition-button, #today .detail-button {
        background: linear-gradient(135deg, #4caf50, #388e3c);
        color: white;
        font-size: 13px;
        font-weight: 500;
        padding: 8px 16px;
        border: none;
        border-radius: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
      }

      #parts .requisition-button:hover, #today .detail-button:hover {
        background: linear-gradient(135deg, #388e3c, #4caf50);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      #parts .requisition-button:focus, #today .detail-button:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
      }

      #parts .requisition-button:active, #today .detail-button:active {
        transform: translateY(1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      #parts .swal2-input {
        margin: 4px 0;
        width: 100%;
        box-sizing: border-box;
        border-radius: 6px;
        font-size: 14px;
        padding: 6px;
        height: 36px;
      }

      #parts .swal2-select {
        margin: 4px 0;
        width: 100%;
        padding: 6px;
        box-sizing: border-box;
        border-radius: 6px;
        font-size: 14px;
        height: 36px;
      }

      #parts .swal2-label {
        font-weight: 500;
        margin: 8px 0 4px;
        display: block;
        text-align: left;
        font-size: 14px;
      }

      #parts .invalid-input {
        border: 2px solid #ef5350 !important;
        box-shadow: 0 0 5px rgba(239, 83, 80, 0.3);
      }

      #parts .error-message {
        color: #ef5350;
        font-size: 12px;
        margin-top: 2px;
        display: block;
        text-align: left;
      }

      #parts a {
        text-decoration: none;
        color: #2196f3;
      }

      #parts a:hover {
        color: #1565c0;
      }

      #parts img {
        transition: transform 0.2s ease;
      }

      #parts img:hover {
        transform: scale(1.1);
      }

      #today .status-green {
        color: #4caf50;
        font-weight: bold;
      }

      #today .status-red {
        color: #ef5350;
        font-weight: bold;
      }

      #today .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        opacity: 0;
        transform: scale(0.95);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }

      #today .modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(to bottom right, #ffffff, #f5f7fa);
        padding: 20px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        animation: fadeIn 0.3s ease;
        font-family: "Poppins", sans-serif;
        z-index: 1001;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
      }

      #today .close {
        color: #78909c;
        float: right;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s;
      }

      #today .close:hover {
        color: #e53935;
      }

      #today #modalContent {
        margin-top: 15px;
      }

      #today #modalContent div {
        padding: 10px 0;
        border-bottom: 1px solid #eceff1;
      }

      #today #modalContent div:last-child {
        border-bottom: none;
      }

      #today #modalContent span.label {
        display: inline-block;
        min-width: 120px;
        font-weight: 500;
        color: #2196f3;
        font-size: 15px;
      }

      #today #modalContent span.value {
        font-size: 15px;
        color: #37474f;
      }

      #today .modal-content h2 {
        color: #e91e63;
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 15px;
      }

      #today .spinner-container {
        text-align: center;
        padding: 40px 20px;
        color: #2196f3;
        font-size: 15px;
      }

      #today .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #eceff1;
        border-top: 4px solid #2196f3;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px auto;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      #error-container, #error-container-today {
        display: none;
        text-align: center;
        padding: 15px;
        color: #ef5350;
        font-size: 15px;
        background-color: #ffebee;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      #retry-button, #retry-button-today {
        background: linear-gradient(135deg, #ff7043, #f44336);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        margin-top: 10px;
        transition: all 0.3s ease;
      }

      #retry-button:hover, #retry-button-today:hover {
        background: linear-gradient(135deg, #f44336, #ff7043);
        transform: translateY(-2px);
      }

      .swal2-container {
        position: fixed !important;
        z-index: 9999;
        overflow-y: auto;
        max-height: 80vh;
      }

      .swal2-popup {
        max-width: 320px !important;
        padding: 15px !important;
        font-size: 14px !important;
        border-radius: 10px !important;
      }

      .swal2-content {
        padding-bottom: 150px !important;
      }

      .swal2-title {
        font-size: 18px !important;
        margin-bottom: 10px !important;
      }

      .swal2-actions {
        margin-top: 10px !important;
      }

      .swal2-confirm, .swal2-cancel {
        font-size: 14px !important;
        padding: 8px 16px !important;
      }

      .swal2-confirm:disabled {
        background: #b0bec5 !important;
        cursor: not-allowed !important;
        opacity: 0.6;
      }

      .autocomplete-items {
        max-height: 120px;
        border-radius: 6px;
      }

      .autocomplete-item {
        padding: 6px;
        font-size: 14px;
      }

      .swal2-qrcode {
        display: block;
        margin: 10px auto;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .swal2-spinner-container {
        text-align: center;
        padding: 20px;
        color: #2196f3;
        font-size: 15px;
      }

      .swal2-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #eceff1;
        border-top: 4px solid #2196f3;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px auto;
      }

      @media screen and (max-width: 360px) {
        .swal2-popup {
          max-width: 300px !important;
        }

        .swal2-input, .swal2-select {
          font-size: 13px;
          height: 34px;
        }

        .swal2-label {
          font-size: 13px;
        }

        .autocomplete-item {
          font-size: 13px;
        }

        .swal2-qrcode {
          width: 120px !important;
          height: 120px !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>ระบบขอเบิกอะไหล่คลังสินค้านวนคร</h1>
    </div>

    <div class="loading" id="loading">
      <span>กำลังโหลดข้อมูล...</span>
    </div>

    <div class="container">
      <div class="tabs">
        <button class="tab-button active" id="tab-parts" onclick="showTab('parts')">
          ค้นหาอะไหล่เพื่อเบิก
        </button>
        <button class="tab-button" id="tab-today" onclick="showTab('today')">
          รายการเบิกประจำวันนี้
        </button>
        <button class="tab-button" id="tab-all" onclick="showTab('all')">
          ประวัติการเบิกอะไหล่
        </button>
        <button class="tab-button" id="tab-pending-calls" onclick="showTab('pending-calls')">
          อะไหล่จ่ายตาม Call
        </button>
      </div>

      <div id="parts" class="tab-content active">
        <div id="searchContainer">
          <input type="text" id="searchInput" placeholder="ค้นหา Code, Description...." />
          <button id="searchButton" class="refresh-button">
            <i class="fas fa-search"></i>
          </button>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <div id="error-container">
          <p id="error-message">เกิดข้อผิดพลาดในการโหลดข้อมูล กรุณาตรวจสอบการเชื่อมต่อหรือลองใหม่</p>
          <button id="retry-button">ลองใหม่</button>
        </div>
        <div class="table-container">
          <table id="data-table">
            <thead>
              <tr>
                <th>เบิก</th>
                <th>Material</th>
                <th>Description</th>
                <th>วิภาวดี</th>
                <th>นวนคร</th>
                <th>Rebuilt</th>
                <th>หมายเหตุ</th>
                <th>Product</th>
                <th>Spec</th>
                <th>Image</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="pagination" class="pagination">
          <button id="firstPage">
            <i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i>
          </button>
          <button id="prevPage"><i class="fas fa-chevron-left"></i></button>
          <div id="pageNumbers"></div>
          <button id="nextPage"><i class="fas fa-chevron-right"></i></button>
          <button id="lastPage">
            <i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i>
          </button>
          <div class="items-per-page">
            <label for="itemsPerPage">Show</label>
            <select id="itemsPerPage">
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="30">30</option>
            </select>
          </div>
        </div>
      </div>

      <div id="today" class="tab-content">
        <div id="searchContainer">
          <input type="text" id="searchInputToday" placeholder="ค้นหา Code, Material, ชื่อช่าง หรือ ทีม..." />
        </div>
        <div id="error-container-today" class="error-container" style="display: none;">
          <p id="error-message-today">เกิดข้อผิดพลาดในการโหลดข้อมูล กรุณาตรวจสอบการเชื่อมต่อหรือลองใหม่</p>
          <button id="retry-button-today">ลองใหม่</button>
        </div>
        <div id="loadingToday" class="spinner-container">
          <div class="spinner"></div>
          <p>กำลังโหลดข้อมูล...</p>
        </div>
        <div class="table-container">
          <table id="data-table-today">
            <thead>
              <tr>
                <th>Status</th>
                <th>วันเวลาบันทึก</th>
                <th>Material</th>
                <th>Description</th>
                <th>จำนวน</th>
                <th>วิภาวดี</th>
                <th>ชื่อช่าง</th>
                <th>หน่วยงาน</th>
                <th>Call</th>
                <th>CallType</th>
                <th>หมายเหตุ</th>
                <th>ดูรายละเอียด</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="detailModal" class="modal">
          <div class="modal-content">
            <span class="close" id="closeModal">×</span>
            <h2>รายละเอียด</h2>
            <div id="modalContent"></div>
          </div>
        </div>
      </div>

      <div id="all" class="tab-content">
        <iframe src="https://nawahovvp.github.io/Request888ALL/" onload="hideLoading()"></iframe>
      </div>

      <div id="pending-calls" class="tab-content">
        <iframe src="https://call-wait-issu.vercel.app/" onload="hideLoading()"></iframe>
      </div>
    </div>

    <div class="footer">
      <p>© 2025 คลังสินค้า SparePart วิภาวดี 62 | สงวนลิขสิทธิ์</p>
    </div>

    <div class="social-buttons">
      <a href="https://www.facebook.com/yourpage" target="_blank" class="social-button facebook">
        <i class="fab fa-facebook-f"></i>
      </a>
      <a href="https://www.tiktok.com/@yourprofile" target="_blank" class="social-button tiktok">
        <i class="fab fa-tiktok"></i>
      </a>
      <a href="https://t.me/yourchannel" target="_blank" class="social-button telegram">
        <i class="fab fa-telegram-plane"></i>
      </a>
      <button class="social-button qrcode" onclick="showQRCode()">
        <i class="fas fa-qrcode"></i>
      </button>
    </div>

    <script>
      function showTab(tabId) {
        const buttons = document.querySelectorAll(".tab-button");
        const contents = document.querySelectorAll(".tab-content");

        document.getElementById("loading").style.display = "flex";

        buttons.forEach((btn) => btn.classList.remove("active"));
        contents.forEach((tab) => tab.classList.remove("active"));

        const targetTab = document.getElementById(tabId);
        targetTab.classList.add("active");

        const clickedButton = Array.from(buttons).find(
          (btn) => btn.id === `tab-${tabId}`
        );
        if (clickedButton) clickedButton.classList.add("active");

        if (tabId === "parts") {
          loadData();
        } else if (tabId === "today") {
          loadTodayData();
        } else if (tabId === "all" || tabId === "pending-calls") {
          const iframe = targetTab.querySelector("iframe");
          if (iframe) {
            const src = iframe.src;
            iframe.src = "";
            iframe.src = src;
          }
          hideLoading();
        }
      }

      function hideLoading() {
        document.getElementById("loading").style.display = "none";
      }

      function showQRCode() {
        Swal.fire({
          title: '📷 สแกน QR Code',
          html: `
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://request888.vercel.app/" alt="QR Code" class="swal2-qrcode" style="width: 150px; height: 150px;">
            <p>สแกนเพื่อเข้าสู่ระบบขอเบิกอะไหล่</p>
          `,
          confirmButtonText: 'ปิด',
          customClass: {
            popup: 'swal2-popup',
            title: 'swal2-title',
            confirmButton: 'swal2-confirm'
          }
        });
      }

      const sheetID = "1nbhLKxs7NldWo_y0s4qZ8rlpIfyyGkR_Dqq8INmhYlw";
      const sheetName = "MainSap";
      const url = `https://opensheet.elk.sh/${sheetID}/${sheetName}`;

      const searchInput = document.getElementById("searchInput");
      const searchButton = document.getElementById("searchButton");
      const tableBody = document.querySelector("#data-table tbody");
      const pagination = document.getElementById("pagination");
      const pageNumbers = document.getElementById("pageNumbers");
      const itemsPerPageSelect = document.getElementById("itemsPerPage");
      const firstPageButton = document.getElementById("firstPage");
      const prevPageButton = document.getElementById("prevPage");
      const nextPageButton = document.getElementById("nextPage");
      const lastPageButton = document.getElementById("lastPage");
      const errorContainer = document.getElementById("error-container");
      const retryButton = document.getElementById("retry-button");

      let allData = [];
      let currentPage = 1;
      let itemsPerPage = 10;
      let currentFilteredData = [];

      itemsPerPageSelect.addEventListener("change", () => {
        itemsPerPage = parseInt(itemsPerPageSelect.value, 10);
        currentPage = 1;
        renderTableData();
        renderPagination(allData.length);
      });

      retryButton.addEventListener("click", () => {
        errorContainer.style.display = "none";
        loadData();
      });

      function renderTable(data) {
        if (!tableBody) {
          console.error("Table body for #data-table not found");
          Swal.fire({
            icon: "error",
            title: "ข้อผิดพลาด",
            text: "ไม่พบตารางข้อมูล กรุณาตรวจสอบโครงสร้างหน้าเว็บ",
            confirmButtonText: "ตกลง",
          });
          return;
        }
        tableBody.innerHTML = "";
        data.forEach((row) => {
          const tr = document.createElement("tr");

          const requisitionTd = document.createElement("td");
          const btn = document.createElement("button");
          btn.textContent = "เบิก";
          btn.className = "requisition-button";
          btn.onclick = () => showRequisitionDialog(row);
          requisitionTd.appendChild(btn);
          tr.appendChild(requisitionTd);

          const columns = [
            "Material",
            "Description",
            "วิภาวดี",
            "Unrestricted",
            "Rebuilt",
            "หมายเหตุ",
            "Product",
            "OCRTAXT",
            "UrlWeb",
          ];

          // Convert values to numbers for comparison
          const vibhavadiValue = parseFloat(row["วิภาวดี"]) || 0;
          const unrestrictedValue = parseFloat(row["Unrestricted"]) || 0;

          // Determine styling based on conditions
          let textColor = "";
          let fontWeight = "";
          if (vibhavadiValue > 0) {
            textColor = "#4caf50"; // Green
            fontWeight = "bold";
          } else if (vibhavadiValue === 0 && unrestrictedValue > 0) {
            textColor = "#2196f3"; // Blue
            fontWeight = "bold";
          }

          columns.forEach((col) => {
            const td = document.createElement("td");
            let value = row[col] || "";

            if (col === "วิภาวดี" || col === "Unrestricted") {
              if (value && !isNaN(value)) {
                value = Number(value).toLocaleString("en-US", {
                  maximumFractionDigits: 0,
                });
              } else if (value === "0" || value === 0) {
                value = "";
              }
            }

            if ((col === "หมายเหตุ" || col === "Rebuilt") && value) {
              td.style.color = "red";
              td.style.fontWeight = "bold";
            }

            // Apply conditional styling to Material, Description, วิภาวดี, and Unrestricted
            if (
              col === "Material" ||
              col === "Description" ||
              col === "วิภาวดี" ||
              col === "Unrestricted"
            ) {
              if (textColor) td.style.color = textColor;
              if (fontWeight) td.style.fontWeight = fontWeight;
            }

            if (col === "UrlWeb" && value && value.startsWith("https://drive.google.com/uc?")) {
              td.innerHTML = `
                <a href="${value}" target="_blank">
                 <button class="view-image-btn">ดูรูป</button>
                </a>
              `;
            } else if (col === "UrlWeb" && value) {
              td.innerHTML = `
                <a href="${value}" target="_blank">
                  <button class="view-image-btn">ดูรูป</button>
                </a>
              `;
            } else {
              td.textContent = value;
            }
            tr.appendChild(td);
          });

          tableBody.appendChild(tr);
        });
      }

      async function showRequisitionDialog(row) {
        document.body.style.overflow = 'hidden';

        const history = {
          employeeCode: getFromLocalStorage('employeeCode'),
          team: getFromLocalStorage('team'),
          contact: getFromLocalStorage('contact'),
          callNumber: getFromLocalStorage('callNumber'),
          callType: getFromLocalStorage('callType'),
        };

        Swal.fire({
          title: '📋 เบิกอะไหล่นวนคร',
          html: `
            <style>
              .autocomplete-items {
                position: absolute;
                border: 1px solid #ccc;
                border-top: none;
                z-index: 9999;
                background-color: white;
                width: 100%;
                max-height: 120px;
                overflow-y: auto;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                margin-top: 2px;
                border-radius: 6px;
              }
              .autocomplete-item {
                padding: 6px;
                cursor: pointer;
                font-size: 14px;
              }
              .autocomplete-item:hover {
                background-color: #f1f1f1;
              }
              .swal2-label {
                text-align: left !important;
                display: block !important;
                margin: 8px 0 4px !important;
                font-weight: bold !important;
                width: 100% !important;
              }
              .swal2-input, .swal2-select {
                width: 100% !important;
                margin: 4px 0 !important;
                padding: 6px !important;
                box-sizing: border-box !important;
                font-size: 14px !important;
                height: 36px !important;
              }
              .error-message {
                color: red !important;
                font-size: 12px !important;
                margin-top: 2px !important;
                display: block !important;
                text-align: left !important;
              }
              .invalid-input {
                border: 2px solid red !important;
                box-shadow: 0 0 5px rgba(255, 0, 0, 0.5) !important;
              }
            </style>
            <div class="swal2-label">📦 Material: ${row.Material || ''}</div>
            <div class="swal2-label">📝 Description: ${row.Description || ''}</div>
            <label class="swal2-label">🔢 จำนวน</label>
            <input id="swal-quantity" class="swal2-input" type="number" value="1" min="1">
            <span id="swal-quantity-error" class="error-message"></span>
            <label class="swal2-label">🆔 รหัสพนักงาน</label>
            <input id="swal-employee-code" class="swal2-input" placeholder="7xxxxxx">
            <div id="employee-code-history" class="autocomplete-items" style="display:none;"></div>
            <span id="swal-employee-code-error" class="error-message"></span>
            <label class="swal2-label">👥 ทีม</label>
            <input id="swal-team" class="swal2-input" placeholder="ทีม">
            <div id="team-history" class="autocomplete-items" style="display:none;"></div>
            <span id="swal-team-error" class="error-message"></span>
            <label class="swal2-label">📞 เบอร์ติดต่อ</label>
            <input id="swal-contact" class="swal2-input" placeholder="เช่น 08xxxxxxxx">
            <div id="contact-history" class="autocomplete-items" style="display:none;"></div>
            <span id="swal-contact-error" class="error-message"></span>
            <label class="swal2-label">📄 เลขที่ Call</label>
            <input id="swal-call-number" class="swal2-input" placeholder="2... หรือ ...">
            <div id="call-number-history" class="autocomplete-items" style="display:none;"></div>
            <span id="swal-call-number-error" class="error-message"></span>
            <label class="swal2-label">🗳️ Call Type</label>
            <select id="swal-call-type" class="swal2-select">
              <option value="" disabled selected>เลือก Call Type</option>
              <option value="I">I</option>
              <option value="P">P</option>
              <option value="Q">Q</option>
              <option value="R">R</option>
            </select>
            <span id="swal-call-type-error" class="error-message"></span>
            <label class="swal2-label">🗒️ หมายเหตุ</label>
            <input id="swal-remark" class="swal2-input" placeholder="ไม่บังคับ" readonly>
            <span id="swal-remark-error" class="error-message"></span>
          `,
          focusConfirm: false,
          showCancelButton: true,
          confirmButtonText: 'ยืนยัน',
          cancelButtonText: 'ยกเลิก',
          allowOutsideClick: false,
          allowEscapeKey: false,
          didOpen: () => {
            const quantityInput = document.getElementById('swal-quantity');
            const employeeCodeInput = document.getElementById('swal-employee-code');
            const teamInput = document.getElementById('swal-team');
            const contactInput = document.getElementById('swal-contact');
            const callNumberInput = document.getElementById('swal-call-number');
            const callTypeInput = document.getElementById('swal-call-type');
            const remarkInput = document.getElementById('swal-remark');
            const confirmButton = document.querySelector('.swal2-confirm');

            confirmButton.disabled = true;

            function setupAutocomplete(input, key, containerId) {
              input.addEventListener('input', () => {
                const container = document.getElementById(containerId);
                const val = input.value.toLowerCase();
                const items = getFromLocalStorage(key).filter(item => item.toLowerCase().includes(val));
                container.innerHTML = '';
                items.forEach(item => {
                  const div = document.createElement('div');
                  div.className = 'autocomplete-item';
                  div.textContent = item;
                  div.onclick = () => {
                    input.value = item;
                    container.style.display = 'none';
                    validateInputs();
                  };
                  container.appendChild(div);
                });
                container.style.display = items.length ? 'block' : 'none';
              });
              input.addEventListener('blur', () => {
                setTimeout(() => {
                  const container = document.getElementById(containerId);
                  container.style.display = 'none';
                }, 200);
              });
            }

            setupAutocomplete(employeeCodeInput, 'employeeCode', 'employee-code-history');
            setupAutocomplete(teamInput, 'team', 'team-history');
            setupAutocomplete(contactInput, 'contact', 'contact-history');
            setupAutocomplete(callNumberInput, 'callNumber', 'call-number-history');
            setupAutocomplete(callTypeInput, 'callType', 'call-type-history');

            const lastTeam = getFromLocalStorage('team')[0];
            const lastContact = getFromLocalStorage('contact')[0];
            if (lastTeam) teamInput.value = lastTeam;
            if (lastContact) contactInput.value = lastContact;

            const inputs = [quantityInput, employeeCodeInput, teamInput, contactInput, callNumberInput, callTypeInput, remarkInput];
            inputs.forEach(input => {
              input.addEventListener('focus', () => {
                const popup = document.querySelector('.swal2-popup');
                popup.style.transform = 'translateY(-20%)';
                popup.style.transition = 'transform 0.3s ease';
              });
              input.addEventListener('blur', () => {
                const popup = document.querySelector('.swal2-popup');
                popup.style.transform = 'translateY(0)';
              });
            });

            function validateInputs() {
              const errors = {
                quantityError: document.getElementById('swal-quantity-error'),
                employeeCodeError: document.getElementById('swal-employee-code-error'),
                teamError: document.getElementById('swal-team-error'),
                contactError: document.getElementById('swal-contact-error'),
                callNumberError: document.getElementById('swal-call-number-error'),
                callTypeError: document.getElementById('swal-call-type-error'),
                remarkError: document.getElementById('swal-remark-error')
              };

              inputs.forEach(input => input.classList.remove('invalid-input'));
              Object.values(errors).forEach(el => el.textContent = '');

              let isValid = true;

              if (!quantityInput.value || quantityInput.value < 1) {
                errors.quantityError.textContent = 'กรุณากรอกจำนวนที่มากกว่าหรือเท่ากับ 1';
                quantityInput.classList.add('invalid-input');
                isValid = false;
              }

              const employeeCode = employeeCodeInput.value.trim();
              if (!employeeCode || !/^\d{7}$/.test(employeeCode) || employeeCode[0] !== '7') {
                errors.employeeCodeError.textContent = 'รหัสพนักงานต้องเป็นตัวเลข 7 หลัก เริ่มด้วย 7 (เช่น 7512411)';
                employeeCodeInput.classList.add('invalid-input');
                isValid = false;
              }

              if (!teamInput.value.trim()) {
                errors.teamError.textContent = 'กรุณากรอกทีม';
                teamInput.classList.add('invalid-input');
                isValid = false;
              }

              if (!contactInput.value || !/^(0|\+66)[6-9][0-9]{7,8}$/.test(contactInput.value)) {
                errors.contactError.textContent = 'กรุณากรอกเบอร์ติดต่อที่ถูกต้อง (เช่น 08xxxxxxxx)';
                contactInput.classList.add('invalid-input');
                isValid = false;
              }

              const hasRemark = remarkInput.value.trim().length > 0;
              if (!hasRemark) {
                if (!callNumberInput.value) {
                  errors.callNumberError.textContent = 'กรุณากรอกเลขที่ Call';
                  callNumberInput.classList.add('invalid-input');
                  isValid = false;
                } else if (
                  (callNumberInput.value.startsWith('2') && callNumberInput.value.length !== 11) ||
                  (!callNumberInput.value.startsWith('2') && callNumberInput.value.length !== 7)
                ) {
                  errors.callNumberError.textContent = 'เลขที่ Call ต้องขึ้นต้นด้วย 2 (11 ตัวอักษร) หรือ (7 ตัวอักษร)';
                  callNumberInput.classList.add('invalid-input');
                  isValid = false;
                }

                if (!callTypeInput.value) {
                  errors.callTypeError.textContent = 'กรุณาเลือก Call Type';
                  callTypeInput.classList.add('invalid-input');
                  isValid = false;
                }
              }

              confirmButton.disabled = !isValid;
            }

            quantityInput.addEventListener('input', validateInputs);
            employeeCodeInput.addEventListener('input', validateInputs);
            teamInput.addEventListener('input', validateInputs);
            contactInput.addEventListener('input', validateInputs);
            callNumberInput.addEventListener('input', validateInputs);
            callTypeInput.addEventListener('change', validateInputs);
            remarkInput.addEventListener('input', validateInputs);

            validateInputs();

            quantityInput.focus();
          },
          didClose: () => {
            document.body.style.overflow = 'auto';
          },
          preConfirm: () => {
            const quantityInput = document.getElementById('swal-quantity');
            const employeeCodeInput = document.getElementById('swal-employee-code');
            const teamInput = document.getElementById('swal-team');
            const contactInput = document.getElementById('swal-contact');
            const callNumberInput = document.getElementById('swal-call-number');
            const callTypeInput = document.getElementById('swal-call-type');
            const remarkInput = document.getElementById('swal-remark');

            const errors = {
              quantityError: document.getElementById('swal-quantity-error'),
              employeeCodeError: document.getElementById('swal-employee-code-error'),
              teamError: document.getElementById('swal-team-error'),
              contactError: document.getElementById('swal-contact-error'),
              callNumberError: document.getElementById('swal-call-number-error'),
              callTypeError: document.getElementById('swal-call-type-error'),
              remarkError: document.getElementById('swal-remark-error')
            };

            [quantityInput, employeeCodeInput, teamInput, contactInput, callNumberInput, callTypeInput, remarkInput].forEach(input => {
              input.classList.remove('invalid-input');
            });

            Object.values(errors).forEach(el => el.textContent = '');

            let isValid = true;

            if (!quantityInput.value || quantityInput.value < 1) {
              errors.quantityError.textContent = 'กรุณากรอกจำนวนที่มากกว่าหรือเท่ากับ 1';
              quantityInput.classList.add('invalid-input');
              isValid = false;
            }

            const employeeCode = employeeCodeInput.value.trim();
            console.log('Employee Code Input:', employeeCode);
            if (!employeeCode || !/^\d{7}$/.test(employeeCode) || employeeCode[0] !== '7') {
              errors.employeeCodeError.textContent = 'รหัสพนักงานต้องเป็นตัวเลข 7 หลัก เริ่มด้วย 7 (เช่น 7512411)';
              employeeCodeInput.classList.add('invalid-input');
              isValid = false;
            }

            if (!teamInput.value.trim()) {
              errors.teamError.textContent = 'กรุณากรอกทีม';
              teamInput.classList.add('invalid-input');
              isValid = false;
            }

            if (!contactInput.value || !/^(0|\+66)[6-9][0-9]{7,8}$/.test(contactInput.value)) {
              errors.contactError.textContent = 'กรุณากรอกเบอร์ติดต่อที่ถูกต้อง (เช่น 08xxxxxxxx)';
              contactInput.classList.add('invalid-input');
              isValid = false;
            }

            const hasRemark = remarkInput.value.trim().length > 0;
            if (!hasRemark) {
              if (!callNumberInput.value) {
                errors.callNumberError.textContent = 'กรุณากรอกเลขที่ Call';
                callNumberInput.classList.add('invalid-input');
                isValid = false;
              } else if (
                (callNumberInput.value.startsWith('2') && callNumberInput.value.length !== 11) ||
                (!callNumberInput.value.startsWith('2') && callNumberInput.value.length !== 7)
              ) {
                errors.callNumberError.textContent = 'เลขที่ Call ต้องขึ้นต้นด้วย 2 (11 ตัวอักษร) หรือ (7 ตัวอักษร)';
                callNumberInput.classList.add('invalid-input');
                isValid = false;
              }

              if (!callTypeInput.value) {
                errors.callTypeError.textContent = 'กรุณาเลือก Call Type';
                callTypeInput.classList.add('invalid-input');
                isValid = false;
              }
            }

            if (isValid) {
              saveToLocalStorage('employeeCode', employeeCode);
              saveToLocalStorage('team', teamInput.value);
              saveToLocalStorage('contact', contactInput.value);
              if (callNumberInput.value) {
                saveToLocalStorage('callNumber', callNumberInput.value);
              }
              if (callTypeInput.value) {
                saveToLocalStorage('callType', callTypeInput.value);
              }

              return {
                quantity: quantityInput.value,
                employeeCode: employeeCode,
                team: teamInput.value,
                contact: contactInput.value,
                callNumber: callNumberInput.value,
                callType: callTypeInput.value,
                remark: remarkInput.value
              };
            }

            return false;
          }
        }).then(async (result) => {
          if (result.isConfirmed) {
            const formValues = result.value;
            const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLScEkPW7y1aM-Zb4YmvL_ytjgSssPZMpiEjOSspQZd_vzo7bRA/formResponse";
            const formData = new URLSearchParams();
            formData.append("entry.1920472981", row.Material);
            formData.append("entry.1467523821", row.Description);
            formData.append("entry.795690319", formValues.quantity);
            formData.append("entry.794964518", formValues.contact);
            formData.append("entry.702998988", formValues.employeeCode);
            formData.append("entry.1899594146", formValues.team);
            formData.append("entry.1607225659", formValues.callNumber);
            formData.append("entry.738519154", formValues.callType);

            Swal.fire({
              title: 'กำลังบันทึกข้อมูล...',
              html: `
                <div class="swal2-spinner-container">
                  <div class="swal2-spinner"></div>
                  <p>กรุณารอสักครู่...</p>
                </div>
              `,
              showConfirmButton: false,
              allowOutsideClick: false,
              allowEscapeKey: false
            });

            try {
              const response = await fetch(formUrl, {
                method: "POST",
                mode: "no-cors",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded"
                },
                body: formData.toString()
              });

              await new Promise(resolve => setTimeout(resolve, 2000));

              Swal.fire({
                icon: 'success',
                title: 'ส่งข้อมูลสำเร็จ!',
                text: 'ข้อมูลได้ถูกบันทึกเรียบร้อยแล้ว',
                confirmButtonText: 'OK'
              }).then((result) => {
                if (result.isConfirmed) {
                  Swal.fire({
                    title: 'กำลังเปลี่ยนหน้า...',
                    html: `
                      <div class="swal2-spinner-container">
                        <div class="swal2-spinner"></div>
                        <p>กรุณารอสักครู่...</p>
                      </div>
                    `,
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    allowEscapeKey: false
                  });

                  setTimeout(() => {
                    Swal.close();
                    showTab('today');
                  }, 2000);
                }
              });
            } catch (error) {
              console.error('เกิดข้อผิดพลาดในการส่งฟอร์ม:', error);
              Swal.fire({
                icon: 'error',
                title: 'เกิดข้อผิดพลาด',
                text: 'ไม่สามารถส่งข้อมูลไปยัง Google Form ได้ กรุณาลองใหม่',
                confirmButtonText: 'ตกลง'
              });
            }
          }
        });
      }

      function saveToLocalStorage(key, value) {
        let items = JSON.parse(localStorage.getItem(key)) || [];
        if (!items.includes(value)) {
          items.unshift(value);
          if (items.length > 5) items.pop();
          localStorage.setItem(key, JSON.stringify(items));
        }
      }

      function getFromLocalStorage(key) {
        return JSON.parse(localStorage.getItem(key)) || [];
      }

      function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        pageNumbers.innerHTML = "";

        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);

        if (totalPages <= 5) {
          startPage = 1;
          endPage = totalPages;
        } else {
          if (currentPage <= 3) {
            endPage = 5;
          } else if (currentPage >= totalPages - 2) {
            startPage = totalPages - 4;
          }
        }

        for (let page = startPage; page <= endPage; page++) {
          const button = document.createElement("button");
          button.textContent = page;
          button.className = page === currentPage ? "active" : "";
          button.onclick = () => changePage(page);
          pageNumbers.appendChild(button);
        }

        firstPageButton.disabled = currentPage === 1;
        prevPageButton.disabled = currentPage === 1;
        nextPageButton.disabled = currentPage === totalPages;
        lastPageButton.disabled = currentPage === totalPages;
      }

      function changePage(page) {
        currentPage = page;
        renderTableData();
        renderPagination(currentFilteredData.length);
      }

      function renderTableData() {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        renderTable(currentFilteredData.slice(startIndex, endIndex));
      }

      searchButton.addEventListener("click", () => {
        const keyword = searchInput.value.trim().toLowerCase();
        if (!keyword) {
          Swal.fire({
            icon: "warning",
            title: "กรุณากรอกคำค้นหา",
            text: "โปรดใส่ข้อความที่ต้องการค้นหาก่อนกดปุ่มค้นหา!",
            confirmButtonText: "ตกลง",
          });
          currentFilteredData = allData;
        } else {
          currentFilteredData = allData.filter((row) => {
            return (
              (row["Material"] || "").toLowerCase().includes(keyword) ||
              (row["Description"] || "").toLowerCase().includes(keyword) ||
              (row["Rebuilt"] || "").toLowerCase().includes(keyword) ||
              (row["Product"] || "").toLowerCase().includes(keyword) ||
              (row["OCRTAXT"] || "").toLowerCase().includes(keyword) ||
              (row["หมายเหตุ"] || "").toLowerCase().includes(keyword)
            );
          });
        }
        currentPage = 1;
        renderTableData();
        renderPagination(currentFilteredData.length);
      });

      searchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          searchButton.click();
          searchInput.blur();
        }
      });

      firstPageButton.addEventListener("click", () => {
        currentPage = 1;
        renderTableData();
        renderPagination(currentFilteredData.length);
      });

      prevPageButton.addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          renderTableData();
          renderPagination(currentFilteredData.length);
        }
      });

      nextPageButton.addEventListener("click", () => {
        const totalPages = Math.ceil(currentFilteredData.length / itemsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderTableData();
          renderPagination(currentFilteredData.length);
        }
      });

      lastPageButton.addEventListener("click", () => {
        const totalPages = Math.ceil(currentFilteredData.length / itemsPerPage);
        currentPage = totalPages;
        renderTableData();
        renderPagination(currentFilteredData.length);
      });

      async function loadData() {
        document.getElementById("loading").style.display = "flex";
        errorContainer.style.display = "none";
        console.log("Starting data load from:", url);

        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000);

          const response = await fetch(url, { signal: controller.signal });
          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log("Data loaded successfully:", data);

          if (!Array.isArray(data) || data.length === 0) {
            throw new Error("No data received or data is empty");
          }

          allData = data;
          currentFilteredData = data;
          renderTableData();
          renderPagination(data.length);
          document.getElementById("loading").style.display = "none";
        } catch (error) {
          console.error("Error loading data:", error);
          document.getElementById("loading").style.display = "none";
          errorContainer.style.display = "block";
          document.getElementById("error-message").textContent = error.message.includes("aborted")
            ? "การโหลดข้อมูลใช้เวลานานเกินไป กรุณาตรวจสอบการเชื่อมต่อ"
            : `ไม่สามารถโหลดข้อมูลได้: ${error.message}`;

          Swal.fire({
            icon: "error",
            title: "ไม่สามารถโหลดข้อมูล",
            text: error.message.includes("aborted")
              ? "การเชื่อมต่อช้าเกินไป กรุณาตรวจสอบเครือข่ายหรือลองใหม่"
              : "ไม่สามารถโหลดข้อมูลจาก Google Sheets ได้ กรุณาตรวจสอบ Sheet ID, ชื่อ Sheet หรือการแชร์สาธารณะ",
            confirmButtonText: "ตกลง",
          });
        }
      }

      const sheetIDToday = "1fPzWLyR0xqU30gyIMSuSCuglKEr76AT1ekCR3mY-nrU";
      const sheetNameToday = "ReQuesttoday";
      const urlToday = `https://opensheet.elk.sh/${sheetIDToday}/${sheetNameToday}`;

      const modal = document.getElementById("detailModal");
      const modalContent = document.getElementById("modalContent");
      const closeModal = document.getElementById("closeModal");
      const searchInputToday = document.getElementById("searchInputToday");
      const tableBodyToday = document.querySelector("#data-table-today tbody");
      const errorContainerToday = document.getElementById("error-container-today");
      const retryButtonToday = document.getElementById("retry-button-today");

      let allDataToday = [];

      retryButtonToday.addEventListener("click", () => {
        errorContainerToday.style.display = "none";
        loadTodayData();
      });

      closeModal.onclick = () => {
        modal.style.opacity = "0";
        modal.style.transform = "scale(0.95)";
        setTimeout(() => (modal.style.display = "none"), 300);
      };

      window.onclick = (event) => {
        if (event.target == modal) closeModal.click();
      };

      function renderTableToday(data) {
        tableBodyToday.innerHTML = "";
        data.forEach((row) => {
          const tr = document.createElement("tr");

          const statusTd = document.createElement("td");
          const status = row["Status"] || "";
          statusTd.textContent = status;
          statusTd.className = status === "สั่งเบิกแล้ว" ? "status-green" : "status-red";
          tr.appendChild(statusTd);

          const columns = [
            "Timestamp",
            "Code",
            "Material Description",
            "จำนวน",
            "วิภาวดี",
            "ชื่อช่าง",
            "หน่วยงาน",
            "CallNumber",
            "CallType",
            "หมายเหตุ",
          ];

          columns.forEach((col) => {
            const td = document.createElement("td");
            let value = row[col] || "";

            if (col === "จำนวน" || col === "วิภาวดี") {
              if (value && !isNaN(value)) {
                value = Number(value).toLocaleString("en-US", { maximumFractionDigits: 0 });
              } else if (value === "0" || value === 0) {
                value = "";
              }
            }

            if (col === "หมายเหตุ" && value) {
              td.style.color = "red";
              td.style.fontWeight = "bold";
            }

            if (col === "Code" && (row["หมายเหตุ"] || "").trim() !== "") {
              td.style.color = "red";
              td.style.fontWeight = "bold";
            }

            if (col === "Material Description" && (row["หมายเหตุ"] || "").trim() !== "") {
              td.style.color = "red";
              td.style.fontWeight = "bold";
            }

            if (col === "Timestamp" && (row["หมายเหตุ"] || "").trim() !== "") {
              td.style.color = "red";
              td.style.fontWeight = "bold";
            }
            if (col === "วิภาวดี" && value) {
              td.style.color = "#4caf50"; // Green color
              td.style.fontWeight = "bold";
           }

            td.textContent = value;
            tr.appendChild(td);
          });

          const detailTd = document.createElement("td");
          const btn = document.createElement("button");
          btn.textContent = "ดูรายละเอียด";
          btn.className = "detail-button";
          btn.onclick = () => {
            modalContent.innerHTML = columns
              .map((col) => {
                let label = "";
                switch (col) {
                  case "Timestamp": label = "📅 วันเวลา"; break;
                  case "Code": label = "🔢 Material"; break;
                  case "Material Description": label = "🛠️ Description"; break;
                  case "จำนวน": label = "🔢 จำนวน"; break;
                  case "ชื่อช่าง": label = "👷‍♂️ ชื่อช่าง"; break;
                  case "หน่วยงาน": label = "🏢 หน่วยงาน"; break;
                  case "CallNumber": label = "📄 Call"; break;
                  case "CallType": label = "🗳️ CallType"; break;
                  case "วิภาวดี": label = "📦 คลังวิภาวดี"; break;
                  case "หมายเหตุ": label = "📝 หมายเหตุ"; break;
                  default: label = col;
                }
                const value = row[col] || "";
                const valueHtml = col === "หมายเหตุ" && value
                  ? `<span class='value' style='color:red'>${value}</span>`
                  : `<span class='value'>${value}</span>`;
                return `<div><span class='label'>${label}:</span> ${valueHtml}</div>`;
              })
              .join("");
            modal.style.display = "block";
            setTimeout(() => {
              modal.style.opacity = "1";
              modal.style.transform = "scale(1)";
            }, 10);
          };
          detailTd.appendChild(btn);
          tr.appendChild(detailTd);

          tableBodyToday.appendChild(tr);
        });
      }

      searchInputToday.addEventListener("input", (e) => {
        const keyword = e.target.value.toLowerCase();
        const filtered = allDataToday.filter((row) => {
          return (
            (row["Code"] || "").toLowerCase().includes(keyword) ||
            (row["Material Description"] || "").toLowerCase().includes(keyword) ||
            (row["ชื่อช่าง"] || "").toLowerCase().includes(keyword) ||
            (row["หน่วยงาน"] || "").toLowerCase().includes(keyword)
          );
        });
        renderTableToday(filtered);
      });

      async function loadTodayData() {
        document.getElementById("loading").style.display = "flex";
        document.getElementById("loadingToday").style.display = "block";
        errorContainerToday.style.display = "none";
        console.log("Starting data load from:", urlToday);

        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000);

          const response = await fetch(urlToday, { signal: controller.signal });
          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log("Today data loaded successfully:", data);

          if (!Array.isArray(data) || data.length === 0) {
            throw new Error("No data received or data is empty");
          }

          allDataToday = data;
          renderTableToday(data);
          document.getElementById("loading").style.display = "none";
          document.getElementById("loadingToday").style.display = "none";
          document.getElementById("data-table-today").style.display = "table";
        } catch (error) {
          console.error("Error loading today data:", error);
          document.getElementById("loading").style.display = "none";
          document.getElementById("loadingToday").style.display = "none";
          errorContainerToday.style.display = "block";
          document.getElementById("error-message-today").textContent = error.message.includes("aborted")
            ? "การโหลดข้อมูลใช้เวลานานเกินไป กรุณาตรวจสอบการเชื่อมต่อ"
            : `ไม่สามารถโหลดข้อมูลได้: ${error.message}`;

          Swal.fire({
            icon: "error",
            title: "ไม่สามารถโหลดข้อมูล",
            text: error.message.includes("aborted")
              ? "การเชื่อมต่อช้าเกินไป กรุณาตรวจสอบเครือข่ายหรือลองใหม่"
              : "ไม่สามารถโหลดข้อมูลจาก Google Sheets ได้ กรุณาตรวจสอบ Sheet ID, ชื่อ Sheet หรือการแชร์สาธารณะ",
            confirmButtonText: "ตกลง",
          });
        }
      }

      loadData();
    </script>
  </body>
</html>
